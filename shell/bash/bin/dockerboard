#!/bin/bash

source util-colors.sh
source util-titles.sh

###########
# Docker Board
# Helper to get docker status and some tips (+ composer checkup)
###########

# USAGE
# --------------------------------

if [ $# -lt 1 ]; then
    echo -e "${YELLOW_UL}Usage:${RESET}";
    echo -e "  $(basename "$0") ${BLUE}<command>${RESET}";
    echo "";
    echo -e "${YELLOW_UL}Commands:${RESET}";
    echo -e "  ${GREEN}status${RESET}    Docker checkup";
    echo -e "  ${GREEN}composer${RESET}  Composer checkup - option: ${BLUE}<doctor|update>${RESET}";
    exit 1;
fi


# FUNCTIONS
# --------------------------------

function fnDockerStatus() {
    if [[ -n $(which docker) ]]; then
        styleSubtitle "Docker networks";

        docker network list

        styleSubtitle "Docker images";

        docker images -a

        styleSubtitle "Docker containers";

        docker ps -a

        styleSubtitle "Docker volumes";

        docker volume ls

        styleSubtitle "Docker Reminders";

        echo -e "${BLUE}- Cleanup containers and volumes:${RESET}  docker ps --filter name=testinit-* -aq | xargs docker stop | xargs docker rm -v";
        echo -e "${BLUE}- Cleanup volumes:${RESET}                 docker volume prune";
        echo -e "${BLUE}- Setup:${RESET}                           docker-compose up -d  |  docker-compose down";
    else
        echo "${RED_UL}ERROR:${RESET}${RED} You need to have docker installed.${RESET}"
    fi
}

function fnCheckComposer() {
    styleSubtitle "Composer - Run: $1";

    if [[ -n $(/usr/bin/which composer) ]]; then
        BIN_COMPOSER=$(/usr/bin/which composer);

        case $1 in
            "doctor")
                echo -e "${YELLOW}Path:${RESET}    $BIN_COMPOSER";
                echo -e "${YELLOW}Version:${RESET} $($BIN_COMPOSER --version)";
                ;;
            "update")
                $BIN_COMPOSER self-update;
                ;;
            *)
                echo -e "${RED_UL}ERROR:${RESET} ${RED}\"$1\" is not a valid. Try 'update' or 'doctor'.${RESET}";
                ;;
        esac
    else
        echo -e "${RED_UL}ERROR:${RESET} ${RED}You don't have \"composer\" installed.${RESET}";
    fi
}

# SWITCHER
# --------------------------------

case $1 in
    "check:composer")
        styleTitle "DockerBoard - Checker";
        fnCheckComposer $2;
        ;;
    *)
        styleTitle "DockerBoard";
        fnDockerStatus
        ;;
esac
