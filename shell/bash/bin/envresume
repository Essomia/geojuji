#!/bin/bash

###########
# ENV RESUME
# A helper to get a status for git repository in a folder.
###########


# COLORS
# https://www.tldp.org/HOWTO/Bash-Prompt-HOWTO/x329.html
# --------------------------------

RESET="\033[0m";
BLUE="\033[0;36m";
BLUE_BG="\033[7;36m";
BLUE_UL="\033[4;36m";
GREEN="\033[0;32m";
GREEN_BG="\033[7;32m";
GREEN_UL="\033[4;32m";
RED="\033[0;31m";
RED_BG="\033[7;31m";
RED_UL="\033[4;31m";
YELLOW="\033[0;33m";
YELLOW_BG="\033[7;33m";
YELLOW_UL="\033[4;33m";


# USAGE
# --------------------------------

if [ $# -lt 1 ]; then
    echo -e "${YELLOW_UL}Usage:${RESET}";
    echo -e "  $(basename "$0") ${BLUE}<command> [option: brew|ruby|node|composer]${RESET}";
    echo "";
    echo -e "${YELLOW_UL}Command:${RESET}";
    echo -e "  ${GREEN}check${RESET}   - Check current version of installed packages.";
    echo -e "  ${GREEN}update${RESET}  - Get list of outdated packages.";
    echo -e "  ${GREEN}upgrade${RESET} - Update outdated packages.";
    exit 1;
fi


# FUNCTIONS
# --------------------------------

function resume_title() {
    echo "";
    echo -e "${YELLOW_UL}$1...${RESET}";
}

function resume_subtitle() {
    echo "";
    echo -e "${YELLOW_BG}$(printf "%-$((50))s" " ")${RESET}";
    echo -e "${YELLOW_BG} $1$(printf "%-$((49 - ${#1}))s" " ")${RESET}";
    echo -e "${YELLOW_BG}$(printf "%-$((50))s" " ")${RESET}";
    echo "";
}

function resume_section() {
    echo -e "${YELLOW_UL}$1${RESET}";
}


function resume_fn_check() {
    resume_title "Environment Check";

    if [[ -z $1 || $1 == "brew" ]]; then
        resume_subtitle "Homebrew";

        if [[ -n $(/usr/bin/which brew) ]]; then
            resume_section "Brew version";
            brew --version;
            resume_section "Brew installed packages";
            brew ls --versions;
        else
            echo -e "${RED_UL}ERROR:${RESET}${RED} You don't have homebrew installed.${RESET}";
        fi

        if [[ $1 == "brew" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "ruby" ]]; then
        resume_subtitle "Ruby";

        if [[ -n $(/usr/bin/which ruby) && -n $(/usr/bin/which gem) ]]; then
            resume_section "Ruby version";
            ruby --version;
            resume_section "Gem version";
            gem --version;
            resume_section "Gem installed packages";
            gem list --local;
        else
            echo -e "${RED_UL}ERROR:${RESET}${RED} You don't have ruby or gem installed.${RESET}";
        fi

        if [[ $1 == "ruby" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "node" ]]; then
        resume_subtitle "Node";

        if [[ -n $(/usr/bin/which npm) && -n $(/usr/bin/which node) ]]; then
            resume_section "Node version";
            node --version;
            resume_section "Npm version";
            npm --version;
            resume_section "Npm global installed packages";
            npm list -g --depth=0;
        else
            echo -e "${RED_UL}ERROR:${RESET}${RED} You don't have npm or node installed.${RESET}";
        fi

        if [[ $1 == "node" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "composer" ]]; then
        resume_subtitle "Composer";

        if [[ -n $(/usr/bin/which composer) ]]; then
            resume_section "Composer version";
            composer --version;
        else
            echo -e "${RED_UL}ERROR:${RESET}${RED} You don't have composer installed.${RESET}";
        fi

        if [[ $1 == "composer" ]]; then
            return;
        fi
    fi
}

function resume_fn_update() {
    resume_title "Environment Update";

    if [[ -z $1 || $1 == "brew" ]]; then
        resume_subtitle "Homebrew";

        if [[ -n $(/usr/bin/which brew) ]]; then
            brew update;
            brew outdated;
        fi

        if [[ $1 == "brew" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "ruby" ]]; then
        resume_subtitle "Ruby";

        if [[ -n $(/usr/bin/which ruby) && -n $(/usr/bin/which gem) ]]; then
            gem update --system;
            gem outdated;
        fi

        if [[ $1 == "ruby" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "node" ]]; then
        resume_subtitle "Node";

        if [[ -n $(/usr/bin/which npm) && -n $(/usr/bin/which node) ]]; then
            npm outdated -g --depth=0;
        fi

        if [[ $1 == "node" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "composer" ]]; then
        resume_subtitle "Composer";

        if [[ -n $(/usr/bin/which composer) ]]; then
            echo -e "Composer don't have any global packages.";
        fi

        if [[ $1 == "composer" ]]; then
            return;
        fi
    fi
}

function resume_fn_upgrade() {
    resume_title "Environment Upgrade";

    if [[ -z $1 || $1 == "brew" ]]; then
        resume_subtitle "Homebrew";

        if [[ -n $(/usr/bin/which brew) ]]; then
            brew upgrade;
            brew cleanup -s;
        fi

        if [[ $1 == "brew" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "ruby" ]]; then
        resume_subtitle "Ruby";

        if [[ -n $(/usr/bin/which ruby) && -n $(/usr/bin/which gem) ]]; then
            gem update;
            gem cleanup;
        fi

        if [[ $1 == "ruby" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "node" ]]; then
        resume_subtitle "Node";

        if [[ -n $(/usr/bin/which npm) && -n $(/usr/bin/which node) ]]; then
            npm update -g;
        fi

        if [[ $1 == "node" ]]; then
            return;
        fi
    fi

    if [[ -z $1 || $1 == "composer" ]]; then
        resume_subtitle "Composer";

        if [[ -n $(/usr/bin/which composer) ]]; then
            composer self-update;
        fi

        if [[ $1 == "composer" ]]; then
            return;
        fi
    fi
}


# GIT RESUME
# --------------------------------

if [ -n "$1" ]; then
    case $1 in
        "check")
            resume_fn_check $2
            ;;
        "update")
            resume_fn_update $2
            ;;
        "upgrade")
            resume_fn_upgrade $2
            ;;
        *)
            echo -e "${RED_UL}ERROR:${RESET}${RED} '$1' is not a valid command.${RESET}"
            ;;
    esac
else
    echo -e "${RED_UL}ERROR:${RESET}${RED} You need to give a valid command.${RESET}";
fi
